OpenLayers.Control.ExportMap=OpenLayers.Class(OpenLayers.Control,{type:OpenLayers.Control.TYPE_BUTTON,canvasComponents:[],tileData:{},trigger:function(a){return this.setUpCanvas(a),this.canvasComponents=[],this.tileData={},this.map.layers.forEach(function(a){a.visibility&&(a instanceof OpenLayers.Layer.Vector?this.exportVectorLayer(a):a instanceof OpenLayers.Layer.Grid&&this.exportGridLayer(a))}.bind(this)),this.canvas},setUpCanvas:function(a){a?this.canvas=a:this.canvas=document.createElement("canvas"),this.canvasContext=this.canvas.getContext("2d"),this.canvas.width=this.map.viewPortDiv.clientWidth,this.canvas.height=this.map.viewPortDiv.clientHeight},exportVectorLayer:function(a){if(a.renderer instanceof OpenLayers.Renderer.Canvas){var b=a.renderer;if(null!==b.canvas){var c=b.canvas;this.canvasComponents.push(c.canvas)}}},exportGridLayer:function(a){this.offsetX=parseInt(this.map.layerContainerDiv.style.left),this.offsetY=parseInt(this.map.layerContainerDiv.style.top),this.stitchTiles(a)},stitchTiles:function(a){var b=this;a.grid.forEach(function(c){c.forEach(function(c){var d=a.getURL(c.bounds);b.tileData[d]||(b.tileData[d]={x:c.position.x+b.offsetX,y:c.position.y+b.offsetY}),b.loadImage(d)})})},loadImage:function(a){var b=new Image,c=this;b.onload=function(){var a=c.canvasComponents;a.unshift(this),a.length>=Object.keys(c.tileData).length&&a.forEach(function(a){if(a.toString().indexOf("HTMLCanvasElement")>-1)return c.drawCanvasComponent(a,0,0),!0;var b=c.tileData[a.src];c.drawCanvasComponent(a,b.x,b.y)})},b.src=a},drawCanvasComponent:function(a,b,c){this.canvasContext.drawImage(a,b,c)},CLASS_NAME:"OpenLayers.Control.ExportMap"});