OpenLayers.Control.ExportMap=OpenLayers.Class(OpenLayers.Control,{type:OpenLayers.Control.TYPE_BUTTON,trigger:function(a){this.setUpCanvas(a),Object.size=function(a){var b=0;for(var c in a)a.hasOwnProperty(c)&&b++;return b};var b=this.map.layers;this.canvasComponents=new Array,this.tileData={};for(var c=0;c<b.length;c++){var d=b[c];if(d.visibility!==!1)if(d instanceof OpenLayers.Layer.Vector)this.exportVectorLayer(d);else{if(!(d instanceof OpenLayers.Layer.Grid))continue;this.exportGridLayer(d)}}return this.canvas},setUpCanvas:function(a){void 0===a?this.canvas=document.createElement("canvas"):this.canvas=a,this.canvasContext=this.canvas.getContext("2d"),this.canvas.width=this.map.viewPortDiv.clientWidth,this.canvas.height=this.map.viewPortDiv.clientHeight},exportVectorLayer:function(a){if(a.renderer instanceof OpenLayers.Renderer.Canvas){var b=a.renderer;if(null!==b.canvas){var c=b.canvas;this.canvasComponents.push(c.canvas)}}},exportGridLayer:function(a){this.offsetX=parseInt(this.map.layerContainerDiv.style.left),this.offsetY=parseInt(this.map.layerContainerDiv.style.top),this.stitchTiles(a)},stitchTiles:function(a){for(var b in a.grid){var c=a.grid[b];for(var d in c){var e=c[d],f=a.getURL(e.bounds),g=e.position.x+this.offsetX,h=e.position.y+this.offsetY;void 0===this.tileData[f]&&(this.tileData[f]={x:g,y:h}),this.loadImage(f)}}},loadImage:function(a){var b=new Image,c=this;b.onload=function(){var a=c.canvasComponents;if(a.unshift(this),a.length>=Object.size(c.tileData))for(var b in a){var d=a[b];if(d.toString().indexOf("HTMLCanvasElement")>-1)c.drawCanvasComponent(d,0,0);else{var e=c.tileData[d.src];c.drawCanvasComponent(d,e.x,e.y)}}},b.src=a},drawCanvasComponent:function(a,b,c){this.canvasContext.drawImage(a,b,c)},CLASS_NAME:"OpenLayers.Control.ExportMap"});