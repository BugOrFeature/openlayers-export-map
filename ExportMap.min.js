OpenLayers.Control.ExportMap=OpenLayers.Class(OpenLayers.Control,{type:OpenLayers.Control.TYPE_BUTTON,trigger:function(a){this.setUpCanvas(a);Object.size=function(e){var g=0;for(var f in e){if(e.hasOwnProperty(f)){g++}}return g};var d=this.map.layers;this.canvasComponents=new Array();this.tileData={};for(var c=0;c<d.length;c++){var b=d[c];if(b.visibility===false){continue}if(b instanceof OpenLayers.Layer.Vector){this.exportVectorLayer(b)}else{if(b instanceof OpenLayers.Layer.Grid){this.exportGridLayer(b)}else{continue}}}return this.canvas},setUpCanvas:function(a){if(a===undefined){this.canvas=document.createElement("canvas")}else{this.canvas=a}this.canvasContext=this.canvas.getContext("2d");this.canvas.width=this.map.viewPortDiv.clientWidth;this.canvas.height=this.map.viewPortDiv.clientHeight},exportVectorLayer:function(b){if(!(b.renderer instanceof OpenLayers.Renderer.Canvas)){return}var c=b.renderer;if(c.canvas!==null){var a=c.canvas;this.canvasComponents.push(a.canvas)}},exportGridLayer:function(a){this.offsetX=parseInt(this.map.layerContainerDiv.style.left);this.offsetY=parseInt(this.map.layerContainerDiv.style.top);this.stitchTiles(a)},stitchTiles:function(e){for(var g in e.grid){var d=e.grid[g];for(var h in d){var f=d[h];var c=e.getURL(f.bounds);var b=f.position.x+this.offsetX;var a=f.position.y+this.offsetY;if(this.tileData[c]===undefined){this.tileData[c]={x:b,y:a}}this.loadImage(c)}}},loadImage:function(a){var c=new Image();var b=this;c.onload=function(){var f=b.canvasComponents;f.unshift(this);if(f.length>=Object.size(b.tileData)){for(var e in f){var d=f[e];if(d.toString().indexOf("HTMLCanvasElement")>-1){b.drawCanvasComponent(d,0,0)}else{var g=b.tileData[d.src];b.drawCanvasComponent(d,g.x,g.y)}}}};c.src=a},drawCanvasComponent:function(b,a,c){this.canvasContext.drawImage(b,a,c)},CLASS_NAME:"OpenLayers.Control.ExportMap"});